<!doctype html>

<meta charset="utf-8">
<title>el-grafo INTRO page</title>
<link rel="stylesheet" type="text/css" href="css/style.css">

<script src="scripts/lib/d3.js" charset="utf-8"></script>
<script src="scripts/lib/dagre-d3.js"></script>

<body onLoad="draw0();">
<h2> el-grafo INTRO page </h2>

<div id="introModules">
  <svg id="svgIntroModules">
  </svg>
</div>

<div id="introModulesAux1">
  <svg id="svgIntroModulesAux1">
  </svg>
</div>

<div id="introModulesAux2">
  <svg id="svgIntroModulesAux2">
  </svg>
</div>

<script>

//TO DEFINE THE COLOR PALETTE:
var bio4jColors = ["#0E6580  ","#68DCFF","#1BCAFF","#587680","#16A2CC","#68DCFF","#0E6580 ","#1BCAFF","#587680"];

var color = d3.scale.category10()
    .range(bio4jColors);

///////////////////////////////////

var introModulesWidth = 800;
var introModulesHeight = 250;

    //SVG canvas for modules loading
    svgModules = d3.select("#svgIntroModules")
                .attr("width", 800)
                .attr("height", 250);
    svgModules.append("g")
                .attr("transform", "translate(40,40)")


  titles = ["Bio4j MODULES", "Bio4j DEPENDENCIES"]
  d3.select("#svgIntroModules")
        .selectAll("text")
        .data(titles)
        .enter()
        .append("text") 
        .attr("x", 20)
        .attr("y", function(d, i) { return 30 + i*150; } )
        .attr("text-anchor", "left")
        .text( function(d) { return d; })
        .attr("font-family", "sans-serif")
        .attr("font-size", "14px");

/////////////////////////////// AUXXXX

var introModulesWidthAux1 = 300;
var introModulesHeightAux1 = 300;

    //SVG canvas for modules loading
    svgModulesAux1 = d3.select("#svgIntroModulesAux1")
                .attr("width", introModulesWidthAux1)
                .attr("height", introModulesHeightAux1);

/////////

var introModulesWidthAux2 = 300;
var introModulesHeightAux2 = 300;

    //SVG canvas for modules loading
    svgModulesAux2 = d3.select("#svgIntroModulesAux2")
                .attr("width", introModulesWidthAux2)
                .attr("height", introModulesHeightAux2)
                .append("g");


////////////////////////////////

function draw0() {

  //Complete Domain Model schema:
  url0 = "data/rev_schema_new_ALL_lengths.json";



  d3.json(url0, function(json0) {

    console.log(json0);

    var newjson0 = json0.map(function(x) {
      function colorModule(d, i) { return color(i); }
          return {
            id: x.label,
            //To be updated when the scala model is ready finally        
/*            Nvertex: x.vertexTypes.length,
            Nedges: x.edgeTypes.length,*/

            //Handy numbers took from https://github.com/bio4j/bio4j/tree/master/src/main/java/com/bio4j/model  
            Nvertex: x.vertexTypesLength,
            Nedges: x.edgeTypesLength,

            Dependencies: x.dependencies.length,
            Color: colorModule(x)
            };
        });
      
    console.log(newjson0);


/*    var newJsonBundle = newjson0.map(function(x, i) {
      return 
        key: i,
        values: { module: module, label: x.label, propertyTypes: x.properties }  

    })
*/

////////////////////////////////////////////////////////////
  
      //TO DO
/*      var forcelayoutjson = newjson0.map(function(x) {
          return {
            nodes: { module: module, label: x.label, propertyTypes: x.properties },
            links: { module: module, label: x.label, propertyTypes: x.properties }     
            };
        });
      
    console.log(newjson0);*/
    urlForceLayout = "data/rev_schema_new_forceLayout.json";


////////////////////////////////////////////////////////////

    // -------> 1_MODULES AND DEPENDENCIES buttons/loading

    //MODULES AND DEPENDENCIES
    //Filtering between modules and dependencies. For example with circles and rects
    var shapesToFilter = svgModules.select("g").selectAll("circle")
                          .data(newjson0)
                          .enter();

    //svg for MODULES
    shapesToFilter.append("a")
        .attr("xlink:href", "Test-GO_v9_Main-contextmenu.html")
        .append("circle")
        .filter(function(d) { return d.Dependencies < 1;})
        .attr("id", function(d) { return d.id; })
        .attr("cx", function(d, i) { return i*90} )
        .attr("cy", 30 )
        .attr("r", function(d) { return (5 + (+d.Nvertex) ) } )
        .attr("fill", function(d, i) { return color(i); })
        .style("opacity", 0.5);


    //svg for DEPENDENCIES
    shapesToFilter.append("rect")
        .filter(function(d) { return d.Dependencies >= 1;})
        .attr("x", function(d, i) { return 20 + i*100 })
        .attr("y", 30+140 )
        .attr("width", 20 )
        .attr("height", 1.5 );


   //Filtering between modules and dependencies
   textToFilter = svgModules.select("g").selectAll("text")
                            .data(newjson0)
                            .enter();
    //texts for MODULES
    textToFilter.append("text")
        .filter(function(d) { return d.Dependencies < 1;})
        .text(function(d) {
              return d.id;
            })
        .attr("x", function(d,i) { return i*90} )
        .attr("text-anchor", "middle")
        .attr("y", 65 )
        .attr("font-size", "11px");
    
    //texts for DEPENDENCIES
    textToFilter.append("text")
        .filter(function(d) { return d.Dependencies >= 1;})
        .text(function(d) {
              return d.id;
            })
        .attr("x", function(d,i) { return 20 + i*100 +10; } )
        .attr("text-anchor", "middle")
        .attr("y", 55+140 )
        .attr("font-size", "11px");


 //Function for each module url:
    var urlFunction = function(d) {
      return ("data/rev_" + d + ".json")
    };


    //Onclick on each Module, highlight it, define the url path and run the dagre-d3 lib
    svgModules.select("g").selectAll("circle")
        .on("click", function(d) {
            svgModules.select("g").selectAll("circle")
              .style("stroke-width", 0);

            d3.select(this)
              .style("stroke", d3.select(this).attr("fill"))
              .style("stroke-width", 10)
              .style("stroke-opacity", .3);
            console.log(d.id);
            url = urlFunction(d.id);
            console.log(url);
            colorMod = d3.select(this).attr("fill");
            console.log(colorMod);
            return draw();

          });


})
}

/////////////////////////////////////////////

// AUX2 -> CONVEX HULL
/*var nodes = d3.range(50).map(Object);


var groups = d3.nest().key(function(d) { return d & 3; }).entries(nodes);

console.log(groups);

var groupPath = function(d) {
    return "M" + 
      d3.geom.hull(d.values.map(function(i) { return [i.x, i.y]; }))
        .join("L")
    + "Z";
};

var groupFill = function(d, i) { return color(i & 3); };

var force = d3.layout.force()
    .nodes(nodes)
    .links([])
    .size([introModulesWidthAux2, introModulesHeightAux2])
    .charge(-10)
    .start();

var node = svgModulesAux2.selectAll("circle.node")
    .data(nodes)
  .enter().append("circle")
    .attr("class", "node")
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; })
    .attr("r", 1)
    .style("fill", function(d, i) { return color(i & 3); })
    .style("stroke", function(d, i) { return d3.rgb(color(i & 3)).darker(2); })
    .style("stroke-width", 1.5)
    .call(force.drag);

svgModulesAux2.style("opacity", 1e-6)
  .transition()
    .duration(1000)
    .style("opacity", 1);

force.on("tick", function(e) {

  // Push different nodes in different directions for clustering.
  var k = 2 * e.alpha;
  nodes.forEach(function(o, i) {
    o.x += i & 2 ? k : -k;
    o.y += i & 1 ? k : -k;
  });

  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });

  svgModulesAux2.selectAll("path")
      .data(groups)
      .attr("d", groupPath)
      .enter().insert("path", "circle")
      .style("fill", groupFill)
      .style("stroke", groupFill)
      .style("stroke-width", 20)
      .style("stroke-linejoin", "round")
      .style("opacity", .2)
      .attr("d", groupPath);
});

d3.select("body").on("click", function() {
  nodes.forEach(function(o, i) {
    o.x += (Math.random() - .5) * 40;
    o.y += (Math.random() - .5) * 40;
  });
  force.resume();
});
*/

/////////////////////////////


d3.json("data/rev_schema_forceLayout.json", function(error, graph) {

/*
  var nodes = d3.range(50).map(Object);
  console.log(nodes);
    
  var nodes = d3.range(50).map(Object);
  // console.log(nodesff);


  var groups = d3.nest().key(function(d) { return d & 3; }).entries(nodes);
  console.log(groups);*/
 

  //Function for each module url:
      var lengths = function(d) {
        graph.nodes[d].vertexTypesLength
      };
  
        // console.log(graph.nodes[8].vertexTypesLength);

  var nodes0 = d3.range(graph.nodes[0].vertexTypesLength).map(Object);
  var nodes1 = d3.range(graph.nodes[1].vertexTypesLength).map(Object);
  var nodes2 = d3.range(graph.nodes[2].vertexTypesLength).map(Object);
  var nodes3 = d3.range(graph.nodes[3].vertexTypesLength).map(Object);
  var nodes4 = d3.range(graph.nodes[4].vertexTypesLength).map(Object);
  var nodes5 = d3.range(graph.nodes[5].vertexTypesLength).map(Object);
  var nodes6 = d3.range(graph.nodes[6].vertexTypesLength).map(Object);
  var nodes7 = d3.range(graph.nodes[7].vertexTypesLength).map(Object);
  
  var nodes8 = d3.range(graph.nodes[8].vertexTypesLength).map(Object);
  console.log(nodes2);

/*  var nodes = nodes8;
  console.log(nodes);
*/

/*  var nodes = function(d) {
    return d3.range(d).map(Object);
  };*/

  data = [0,1,2,3,4,5,6,7,8];
/*  var prueba = nodes(data);
  console.log(prueba);*/

  var nodes = d3.range(nodes).map(Object);

/*  var gJSON = eval(nodes0, nodes1);
  console.log(gJSON);*/

/*  var groups = d3.nest()
            .key(function(d) { return d & 3; })
            .entries(nodes);*/

  var groups = d3.nest()
            .key(function(d, i) { return i })
            .entries(nodes);

  console.log(groups);



/*  var nodes2 = graph.nodes.vertexTypesLength;
  var groups2 = d3.nest().key(function(d) { return d & 3; }).entries(nodes2);
  console.log("nodes2" + nodes2);
  console.log(groups2);*/

  console.log(groups);

  var groupPath = function(d) {
      return "M" + 
        d3.geom.hull(d.values.map(function(i) { return [i.x, i.y]; }))
          .join("L")
      + "Z";
  };

  // var groupFill = function(d, i) { return color(i & 3); };

  var groupFill = function(d, i) { return color(i); };


  var force = d3.layout.force()
      .nodes(nodes)
      .links([])
      .size([introModulesWidthAux2, introModulesHeightAux2])
      .charge(-10)
      .start();

  var node = svgModulesAux2.selectAll("circle.node")
      .data(nodes)
      .enter().append("circle")
      .attr("class", "node")
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r", 1)
      .style("fill", function(d, i) { return color(i); })
      .style("stroke", function(d, i) { return d3.rgb(color(i & 3)).darker(2); })
      .style("stroke-width", 1)
      .call(force.drag);

  svgModulesAux2.style("opacity", 1e-6)
    .transition()
      .duration(1000)
      .style("opacity", 1);

  force.on("tick", function(e) {

    // Push different nodes in different directions for clustering.
/*    var k = 2 * e.alpha;
    nodes.forEach(function(o, i) {
      o.x += i & 2 ? k : -k;
      o.y += i & 1 ? k : -k;
    });*/

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });

    svgModulesAux2.selectAll("path")
        .data(groups)
        .attr("d", groupPath)
        .enter().insert("path", "circle")
        .style("fill", groupFill)
        .style("stroke", groupFill)
        .style("stroke-width", 20)
        .style("stroke-linejoin", "round")
        .style("opacity", .2)
        .attr("d", groupPath);
  });


/*  d3.select("body").on("click", function() {
    nodes.forEach(function(o, i) {
      o.x += (Math.random() - .5) * 40;
      o.y += (Math.random() - .5) * 40;
    });
    force.resume();
  });*/

});




/////////////////////////////////////////////

// AUX1 -> FORCE LAYOUT

//Force layout
var force = d3.layout.force()
    .linkDistance(25)
    .linkStrength(1)
    .charge(-150)
    .size([introModulesWidthAux1, introModulesHeightAux1]);

  //Uploading json file
  d3.json("data/rev_schema_forceLayout.json", function(error, graph) {
  var nodes = graph.nodes.slice(),
      links = [],
      bilinks = [];

  graph.links.forEach(function(link) {
    var s = nodes[link.source],
        t = nodes[link.target],
        i = {};                   // intermediate node
    nodes.push(i);
    links.push({source: s, target: i}, {source: i, target: t});
    bilinks.push([s, i, t]);
  });

  force
      .nodes(nodes)
      .links(links)
      .start();



 //Draw NODES as CIRCLES    
  var node = svgModulesAux1.selectAll(".node")
      .data(graph.nodes)
      .enter()
      .append("circle")
      .attr("class", "node")

      // .attr("r", function(d) { return ((+d.vertexTypesLength) + (+d.edgeTypesLength)); })
      .attr("r", function(d) { return 5 +(+d.vertexTypesLength)})

      .style("fill", function(d, i) { return color(i); })
      .style("opacity", .5)
/*      .on("click", click)
      .on("dblclick", dblclick)*/
      .call(force.drag);

 d3.geom.hull(node);


// console.log(function(graph.nodes) return {vertexTypesLength(1)});

  //Draw LINKS as PATHS    
  var link = svgModulesAux1.selectAll(".link")
      .data(bilinks)
      .enter()
      .append("path")
      .attr("class", "link");

  //Labels vertex
  var labelsVertex = svgModulesAux1.selectAll("text1")
         .data(graph.nodes)
         .enter()
         .append("text")
         .text(function(d) { return d.label; })
         .attr("x", function(d) { return d.x; })
         .attr("y", function(d) { return d.y; })
         .attr("text-anchor", "middle")
         .attr("font-family", "sans-serif")
         .attr("font-size", "11px")
         .attr("fill", "black");
         //.remove();

   
  //Labels edges
  var labelsEdges = svgModulesAux1.selectAll("text3")
         .data(graph.links)
         .enter()
         .append("text")
         .attr("text-anchor", "middle")
         .text(function(d) { return d.label; })
         .attr("x", function(d) { return d.source.x; })
         .attr("y", function(d) { return d.source.y; })
         .attr("font-family", "sans-serif")
         .attr("font-size", "8px")
         .attr("fill", "grey")
         // .remove();



  force.on("tick", function() {


    link.attr("d", function(d) {
      return "M" + d[0].x + "," + d[0].y
          + "S" + d[1].x + "," + d[1].y 
          + " " + d[2].x + "," + d[2].y;
    });
   


    node.attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });


    labelsVertex.attr("x", function(d) { return d.x; })       
                .attr("y", function(d) { return d.y + 3; }); 

/*    labelsEdges.attr("x", function(d) { return ((d.source.x + d.target.x)/2); })       
                .attr("y", function(d) { return ((d.source.y + d.target.y)/2); });  */

  });

});



</script>


