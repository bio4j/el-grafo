<!doctype html>

<meta charset="utf-8">
<title>el-grafo INTRO page</title>
<link rel="stylesheet" type="text/css" href="css/style.css">

<script src="scripts/lib/d3.js" charset="utf-8"></script>
<script src="scripts/lib/dagre-d3.js"></script>

<script src='http://code.jquery.com/jquery-1.8.3.js'></script>

<body onLoad="draw0();">
<h2> el-grafo INTRO page </h2>

<!-- <div id="textoVariable">
    <h2> </h2>
</div>
 -->

<div id="introModules">
  <svg id="svgIntroModules">
  </svg>
</div>

<div id="introModulesAux1">
  <svg id="svgIntroModulesAux1">
  </svg>
</div>

<div id="introModulesAux2">
  <svg id="svgIntroModulesAux2">
  </svg>
</div>

    <style>
      /* show or hide the foci for debugging */
      .foci-0, .foci-1, .foci-2, .foci-3, .foci-4, .foci-5, .foci-6, .foci-7, .foci-8{
        display: none;
      }


      .hull {
          stroke-width: 30px;
          stroke-linejoin: round;
          opacity: .2;
      }


    .link {
      fill: none;
      stroke: grey;
      stroke-dasharray: 2, 3;
      stroke-width: 1;
    }


    line {
      fill: none;
      stroke: grey;
      stroke-dasharray: 2, 3;
      stroke-width: 1;
    }
    </style>

<script>

//Linking texts from another url on server
    var myUrl1 = 'Test-GO_v13_Main.html';
     function ParseUrl(myUrl){
             $.ajax({
                      url: myUrl,
                      success: function(data) {
                             document.getElementById("textoVariable").innerHTML = data;
                             document.getElementById("textoVariable").innerHTML = $("#origenTexto").html();
                      }
             });
     }
     ParseUrl(myUrl1);


//Linking texts from another url on server
/*    var myUrl1 = "https://github.com/bio4j/ncbi-taxonomy-module";
     function ParseUrl(myUrl){
             $.ajax({
                      url: myUrl,
                      success: function(data) {
                             document.getElementById("textoVariable").innerHTML = data;
                             document.getElementById("textoVariable").innerHTML = $("#ncbi-taxonomy-bio4j-module").html();
                      }
             });
     }
     ParseUrl(myUrl1);*/

////////////////////////////////////

//TO DEFINE THE COLOR PALETTE:
var bio4jColors = ["#0E6580  ","#68DCFF","#1BCAFF","#587680","#16A2CC","#68DCFF","#0E6580 ","#1BCAFF","#587680"];

var color = d3.scale.category10()
    .range(bio4jColors);

///////////////////////////////////

var introModulesWidth = 800;
var introModulesHeight = 250;

    //SVG canvas for modules loading
    svgModules = d3.select("#svgIntroModules")
                .attr("width", 800)
                .attr("height", 250);
    svgModules.append("g")
                .attr("transform", "translate(40,40)")


  titles = ["Bio4j MODULES", "Bio4j DEPENDENCIES"]
  d3.select("#svgIntroModules")
        .selectAll("text")
        .data(titles)
        .enter()
        .append("text") 
        .attr("x", 20)
        .attr("y", function(d, i) { return 30 + i*150; } )
        .attr("text-anchor", "left")
        .text( function(d) { return d; })
        .attr("font-family", "sans-serif")
        .attr("font-size", "14px");

/////////////////////////////// AUXXXX

var introModulesWidthAux1 = 300;
var introModulesHeightAux1 = 300;

    //SVG canvas for modules loading
    svgModulesAux1 = d3.select("#svgIntroModulesAux1")
                .attr("width", introModulesWidthAux1)
                .attr("height", introModulesHeightAux1);

/////////

var introModulesWidthAux2 = 900;
var introModulesHeightAux2 = 400;

    //SVG canvas for modules loading
    svgModulesAux2 = d3.select("#svgIntroModulesAux2")
                .attr("width", introModulesWidthAux2)
                .attr("height", introModulesHeightAux2)
                .append("g");


////////////////////////////////

function draw0() {

  //Complete Domain Model schema:
  url0 = "data/rev_schema_new_ALL_lengths.json";



  d3.json(url0, function(json0) {

    console.log(json0);

    var newjson0 = json0.map(function(x) {
      function colorModule(d, i) { return color(i); }
          return {
            id: x.label,
            //To be updated when the scala model is ready finally        
/*            Nvertex: x.vertexTypes.length,
            Nedges: x.edgeTypes.length,*/

            //Handy numbers took from https://github.com/bio4j/bio4j/tree/master/src/main/java/com/bio4j/model  
            Nvertex: x.vertexTypesLength,
            Nedges: x.edgeTypesLength,

            Dependencies: x.dependencies.length,
            Color: colorModule(x)
            };
        });
      
    console.log(newjson0);


////////////////////////////////////////////////////////////
  
      //TO DO
/*      var forcelayoutjson = newjson0.map(function(x) {
          return {
            nodes: { module: module, label: x.label, propertyTypes: x.properties },
            links: { module: module, label: x.label, propertyTypes: x.properties }     
            };
        });
      
    console.log(newjson0);*/
    urlForceLayout = "data/rev_schema_new_forceLayout.json";


////////////////////////////////////////////////////////////

    // -------> 1_MODULES AND DEPENDENCIES buttons/loading

    //MODULES AND DEPENDENCIES
    //Filtering between modules and dependencies. For example with circles and rects
    var shapesToFilter = svgModules.select("g").selectAll("circle")
                          .data(newjson0)
                          .enter();

    //svg for MODULES
    shapesToFilter.append("circle")
        .filter(function(d) { return d.Dependencies < 1;})
        .attr("id", function(d) { return d.id; })
        .attr("cx", function(d, i) { return i*90} )
        .attr("cy", 30 )
        .attr("r", function(d) { return (5 + (+d.Nvertex) ) } )
        .attr("fill", function(d, i) { return color(i); })
        .style("opacity", 0.5);


    //svg for DEPENDENCIES
    shapesToFilter.append("rect")
        .filter(function(d) { return d.Dependencies >= 1;})
        .attr("x", function(d, i) { return 20 + i*100 })
        .attr("y", 30+140 )
        .attr("width", 20 )
        .attr("height", 1.5 );


   //Filtering between modules and dependencies
   textToFilter = svgModules.select("g").selectAll("text")
                            .data(newjson0)
                            .enter();
    //texts for MODULES
    textToFilter.append("text")
        .filter(function(d) { return d.Dependencies < 1;})
        .text(function(d) {
              return d.id;
            })
        .attr("x", function(d,i) { return i*90} )
        .attr("text-anchor", "middle")
        .attr("y", 65 )
        .attr("font-size", "11px");
    
    //texts for DEPENDENCIES
    textToFilter.append("text")
        .filter(function(d) { return d.Dependencies >= 1;})
        .text(function(d) {
              return d.id;
            })
        .attr("x", function(d,i) { return 20 + i*100 +10; } )
        .attr("text-anchor", "middle")
        .attr("y", 55+140 )
        .attr("font-size", "11px");


 //Function for each module url:
    var urlFunction = function(d) {
      return ("data/rev_" + d + ".json")
    };


    //Onclick on each Module, highlight it, define the url path and run the dagre-d3 lib
    svgModules.select("g").selectAll("circle")
        .on("click", function(d) {
            svgModules.select("g").selectAll("circle")
              .style("stroke-width", 0);

            d3.select(this)
              .style("stroke", d3.select(this).attr("fill"))
              .style("stroke-width", 10)
              .style("stroke-opacity", .3);
            console.log(d.id);
            url = urlFunction(d.id);
            console.log(url);
            colorMod = d3.select(this).attr("fill");
            console.log(colorMod);
			color = colorMod.replace("#",""); 
			location.href="Test-GO_v13_Main.html?url="+url+"&color="+color;
            return draw();

          });

})
}


/////////////////////////////////////////



 d3.json("data/rev_schema_forceLayout.json", function(error, graph) {
  
  
  var nodes = graph.nodes


    var Force = function(nodes, links) {
        return d3.layout.force()
            .nodes(nodes)
            .links(links)
            .gravity(0)
            .size([introModulesWidthAux2, introModulesHeightAux2])
            .linkDistance(0)
            .linkStrength(.1)
            .friction(0.9)

            .charge(function(d, i) {
                return d.charge
            })
    };

    var Nodes = function(num, id, name) {
        return d3.range(num).map(function(d) {
            return {
                id: id,
                x: Math.random() * introModulesWidthAux2,
                y: Math.random() * introModulesHeightAux2,
                charge: -2.5,
                name: name,
            }
        })
    };

    console.log(Nodes);

    var Foci = function(x, y, name) {
        return {
            x: x,
            y: y,
            charge: -2.5,
            fixed: true,
            name: name
        }
    };


    var Links = function(nodes, foci) {
        return nodes.map(function(node) {
            return {
                source: node,
                target: foci
            }
        })
    };

    ////

    var LinksModules = function(foci, foci) {
            return {
                source: foci,
                target: foci
            }
    };

//////////////

    numberModules = graph.nodes.length;
    modulesTemporary = ["0", "1", "2", "3", "4", "5", "6", "7" , "8"];

    var hull = svgModulesAux2
        .selectAll("path")
        .data(modulesTemporary)
        .enter()
        .append("path")
        .attr("class", "hull")
        .attr("id", function(d,i) {return "path" + i});


/////////////


    //TO DEFINE THE COLOR PALETTE:
    var bio4jColors = ["#0E6580", "#68DCFF", "#1BCAFF", "#587680", "#16A2CC", "#68DCFF", "#0E6580 ", "#1BCAFF", "#587680"];

    var color = d3.scale.category10()
        .range(bio4jColors);



    //TO DO: convert this in a function:
        // var lengths = function(d) {
    /*    for (i = 0, longitud = 8; i < longitud; i++){
            return graph.nodes[i].vertexTypesLength
        };
    */
        // console.log(graph.nodes[8].vertexTypesLength);


    var NumNodes = new Array(graph.nodes.length);
		var NumEdges = new Array(graph.nodes.length);
		var nodesv = new Array(graph.nodes.length);
		var nodese = new Array(graph.nodes.length);
		var nodesVector = new Array(graph.nodes.length);
		
    for(i = 0, longitud = graph.nodes.length; i < longitud; i++){
			NumNodes[i] = graph.nodes[i].vertexTypesLength;
			NumEdges[i] = graph.nodes[i].edgeTypesLength;
			nodesv[i] = Nodes(NumNodes[i], i, 'node-'+i),
			nodese[i] = Nodes(NumEdges[i], i, 'edge-'+i),
			nodesVector[i] = nodesv[i].concat(nodese[i]);
		}

/*      console.log(nodes0v);
      console.log(nodes0e);
      console.log(nodesVector[0]);
*/
    //Number of modules
    var n = graph.nodes.length,
    xUniprot = introModulesWidthAux2 / (n+1) + 300;
    yUniprot = (introModulesHeightAux2 / 2);

	var foci = new Array(graph.nodes.length);
	var links = new Array(graph.nodes.length);
	for(i = 0, longitud = graph.nodes.length; i < longitud; i++){
		foci[i] = Foci(xUniprot + i*80 -250, yUniprot + 40, graph.nodes[0].label);
		links[i]  = Links(nodesVector[i], foci[i]);
	}


        // linksAux = LinksModules(foci[7], foci[8]);

        console.log("links[8]", links[8]);
        // console.log("linksAux", linksAux);

		
	var aux = new Array(graph.nodes.length);

    var all = nodesVector[0].concat(nodesVector[1]);

	for(i = 2, longitud = graph.nodes.length; i < longitud; i++){
		if(i+1 != longitud)
			all = all.concat(nodesVector[i]);
		else{
			all = all.concat(nodesVector[i]);
			for(i = 0, longitud = graph.nodes.length; i < longitud; i++)
				aux[i] = (foci[i]);
				
			all = all.concat(aux);
		}
	}

    // for(i = 2, longitud = graph.nodes.length; i < longitud; i++){
        
    //     all = all.concat(nodesVector[i]);
       
    // }

    console.log("foci[3]", foci[3])

/*    var all = nodes[0].concat(nodes[1]).concat(nodes[2]).concat(nodes[3]).concat(nodes[4]).concat(nodes[5]).concat(nodes[6]).concat(nodes[7]).concat(nodes[8]).concat([             foci[0], foci[1], foci[2], foci[3], foci[4], foci[5], foci[6], foci[7], foci[8] ]);*/


	var forceAux = links[0];
	for(i = 1, longitud = graph.nodes.length; i < longitud; i++)
		forceAux = forceAux.concat(links[i]);
		
    force = Force(all, forceAux);

    // forceAux = Force(foci[7].concat(foci[8]), linksAux);

/*    force = Force(all, links[0].concat(links[1]).concat(links[2]).concat(links[3]).concat(links[4]).concat(links[5]).concat(links[6]).concat(links[7]).concat(links[8]))*/
    
    console.log("all", all);
    console.log("force", force);
    // console.log("forceAux", forceAux);

    force.on('tick', function() {
        // svgModulesAux2.selectAll('circle')
            types.attr('cx', function(d) {
                return d.x = Math.max(r, Math.min(introModulesWidthAux2 - r, d.x));
            })
            .attr('cy', function(d) {
                return d.y = Math.max(r, Math.min(introModulesHeightAux2 - r, d.y)); 
            });

            labels.attr("x", function(d) { return d.x + 40; })       
                .attr("y", function(d) { return d.y; }); 


            //SIMPLE NO GROUPING PATH, WORKING
/*            svgModulesAux2.selectAll("path")
                .data([d3.geom.hull(all.map(function(d) { return [ d.x, d.y ]; }))])
                .attr("d", function(d) { return "M" + d.join("L") + "Z"; });*/

            var allNodes = []
            // var multiplePaths = d3.geom.hull(function(d,i) {return allNodes[i]})
            var multiplePaths = d3.geom.hull([nodesVector[5], nodesVector[7], nodesVector[8]]);
            // var multiplePaths = d3.geom.hull(nodes);
            // console.log(multiplePaths);

            //TO DO: If the number of elements is <3, not doing convex hull or invent something.
            //FUNCTION NOT WORKING
/*            svgModulesAux2.selectAll("path")
                .data([multiplePaths.map(function(d) { return [ d.x, d.y ]; })])
                .attr("d", function(d) { return "M" + d.join("L") + "Z"; });*/

/*            svgModulesAux2.selectAll("path")
                .data([d3.geom.hull(nodesVector[7].map(function(d) { return [ d.x, d.y ]; }))])
                .attr("d", function(d) { return "M" + d.join("L") + "Z"; });*/
                // .attr("id", "path7");

            //TEMPORARY SELECTING BY ID

/*            svgModulesAux2.select("#path5")
                .data([d3.geom.hull(nodesVector[5].map(function(d) { return [ d.x, d.y ]; }))])
                .attr("d", function(d) { return "M" + d.join("L") + "Z"; });*/

/*            console.log("nodesVector[1]", nodesVector[1]);
            console.log("newnodes1", newnodes1);*/

			for(i = 0, longitud = graph.nodes.length; i < longitud; i++){
				if((NumNodes[i]) >= 3){
					svgModulesAux2.select("#path"+i)
						.data([d3.geom.hull(nodesVector[i].map(function(d) { return [ d.x, d.y ]; }))])
						.attr("d", function(d) { return "M" + d.join("L") + "Z"; })
						.style("fill", bio4jColors[i] )
						.style("stroke", bio4jColors[i] );
						
				}
			}

            //GROUPING BY MODULE:
/*            svgModulesAux2.selectAll("path")
                .data(allGroups)
                .attr("d", groupPath)
                .enter().insert("path", "circle")
                .style("fill", "red")
                .style("stroke", "red")
                .style("stroke-width", 20)
                .style("stroke-linejoin", "round")
                .style("opacity", .2)
                .attr("d", groupPath);
                */

             svgModulesAux2.selectAll("labels")
                .attr('x', function(d) {
                return d.foci[8].x
            })
                .attr('y', function(d) {
                return d.foci[8].y
            });
});



    ///////////////////

    console.log(all);

    //All vertex and edges: 
    svgtypes = svgModulesAux2
        .append("g")
        .attr("id", "modulesTypes")
        .selectAll('types')
        .data(all)
        .enter()

    console.log("all", all);

    var r = 1.6; 

    types = svgtypes.append('circle')
        // .filter(function(d, i) { return i < 2;})
        .attr({
            cx: function(d) {
                return d.x
            },
            cy: function(d) {
                return d.y
            },
            r: r,
            'class': function(d) {
                return d.name
            }
        })
        .style("fill", function(d) {
            return color(d.id)
        })
        .call(force.drag);


    //LINKS MANUALLY

/*    var lineData = [ { "x": foci[7].x,   "y": foci[7].y},  { "x": foci[8].x,  "y": foci[8].y } ];

    console.log("lineData", lineData);
    
    var lineFunction = d3.svg.line()
                          .x(function(d) { return d.x; })
                          .y(function(d) { return d.y; })
                          .interpolate("linear");

    svgModulesAux2.append("line")
        .attr("d", lineFunction(lineData))
        .attr("stroke", "blue")
        .attr("stroke-width", 2)
        .attr("fill", "none");*/

	for(i = 0, longitud = graph.links.length; i < longitud; i++){
		svgModulesAux2.append('line')
			.attr("x1", foci[graph.links[i].target].x)
			.attr("x2", foci[graph.links[i].source].x)
			.attr("y1", foci[graph.links[i].target].y)
			.attr("y2", foci[graph.links[i].source].y)
			.style("stroke", "#ccc");
    }

/*    var lineFunction = d3.svg.line()
                          .x(function(d) { return d.x; })
                          .y(function(d) { return d.y; })
                          .interpolate("linear");*/

/*  var linkAux = svgModulesAux2.selectAll(".link")
      .data(linkAux)
      .enter()
      .append("path")
      .attr("class", "link");*/

    var allMap = all.map(function(d) { return [ d.x, d.y ]});
    console.log("all.map", allMap);

    var allGroups = d3.nest()
            .key(function(d) { return d.name;  })
            .entries(all);
    var allGroups0 = allGroups[0];
    console.log("allGroups", allGroups[0]);



    //Filtering all edges:
    d3.selectAll(".edge-0, .edge-1, .edge-2, .edge-3, .edge-4, .edge-5, .edge-6, .edge-7, .edge-8")
        .transition(500)
        .attr("r", .7);

/*    names = [graph.nodes[0].label, graph.nodes[1].label, graph.nodes[2].label, graph.nodes[3].label, graph.nodes[4].label, graph.nodes[5].label, graph.nodes[6].label, graph.nodes[7].label,  graph.nodes[8].label ];*/
    
    focis = [foci[0], foci[1], foci[2], foci[3], foci[4], foci[5], foci[6], foci[7], foci[8] ];
    
    console.log("focis", focis);


/*      labels = svgModulesAux2
        .append("g")
        .attr("id", "modulesText")
        .selectAll("text")        
        .data(names)
        .enter()
        .append("text")
        .text(function(d) { return d })
        .attr("x", function(d, i) {
            return introModulesWidthAux2 / (n+1) + i*75;
        })
        .attr("y", introModulesHeightAux2 / 2)
        .attr("text-anchor", "middle")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("fill", function(d, i) { return color(i)} );*/
/*
    console.log("foci[8]", d3.select("foci[8]").attr("x"));*/
    console.log("foci[8]", foci[8].x);
    // var coordenadaX = foci

    labels = svgModulesAux2
        .append("g")
        .attr("id", "modulesText")
        .selectAll("text")        
        .data(focis)
        .enter()
        .append("text")
        .text(function(d) { return d.name })
        .attr("x", function(d) { return d.x })
        .attr("y", function(d) { return d.y })
        .attr("text-anchor", "middle")
        .attr("font-family", "sans-serif")
        .attr("font-weight", "bold")
        .attr("font-size", "14px")
        .attr("fill", function(d, i) { return color(i)} );

        console.log(foci[5].x);

    force.start();
    
})


</script>






