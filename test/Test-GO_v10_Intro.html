<!doctype html>

<meta charset="utf-8">
<title>el-grafo INTRO page</title>
<link rel="stylesheet" type="text/css" href="css/style.css">

<script src="scripts/lib/d3.js" charset="utf-8"></script>
<script src="scripts/lib/dagre-d3.js"></script>

<body onLoad="draw0();">
<h2> el-grafo INTRO page </h2>

<div id="introModules">
  <svg id="svgIntroModules">
  </svg>
</div>

<div id="introModulesAux1">
  <svg id="svgIntroModulesAux1">
  </svg>
</div>

<div id="introModulesAux2">
  <svg id="svgIntroModulesAux2">
  </svg>
</div>

    <style>
      /* show or hide the foci for debugging */
      .foci-0, .foci-1, .foci-2, .foci-3, .foci-4, .foci-5, .foci-6, .foci-7, .foci-8{
        display: none;
      }


      .hull {
          fill: steelblue;
          stroke: steelblue;
          stroke-width: 32px;
          stroke-linejoin: round;
          opacity: .5;
      }

    </style>

<script>

//TO DEFINE THE COLOR PALETTE:
var bio4jColors = ["#0E6580  ","#68DCFF","#1BCAFF","#587680","#16A2CC","#68DCFF","#0E6580 ","#1BCAFF","#587680"];

var color = d3.scale.category10()
    .range(bio4jColors);

///////////////////////////////////

var introModulesWidth = 800;
var introModulesHeight = 250;

    //SVG canvas for modules loading
    svgModules = d3.select("#svgIntroModules")
                .attr("width", 800)
                .attr("height", 250);
    svgModules.append("g")
                .attr("transform", "translate(40,40)")


  titles = ["Bio4j MODULES", "Bio4j DEPENDENCIES"]
  d3.select("#svgIntroModules")
        .selectAll("text")
        .data(titles)
        .enter()
        .append("text") 
        .attr("x", 20)
        .attr("y", function(d, i) { return 30 + i*150; } )
        .attr("text-anchor", "left")
        .text( function(d) { return d; })
        .attr("font-family", "sans-serif")
        .attr("font-size", "14px");

/////////////////////////////// AUXXXX

var introModulesWidthAux1 = 300;
var introModulesHeightAux1 = 300;

    //SVG canvas for modules loading
    svgModulesAux1 = d3.select("#svgIntroModulesAux1")
                .attr("width", introModulesWidthAux1)
                .attr("height", introModulesHeightAux1);

/////////

var introModulesWidthAux2 = 900;
var introModulesHeightAux2 = 300;

    //SVG canvas for modules loading
    svgModulesAux2 = d3.select("#svgIntroModulesAux2")
                .attr("width", introModulesWidthAux2)
                .attr("height", introModulesHeightAux2)
                .append("g");


////////////////////////////////

function draw0() {

  //Complete Domain Model schema:
  url0 = "data/rev_schema_new_ALL_lengths.json";



  d3.json(url0, function(json0) {

    console.log(json0);

    var newjson0 = json0.map(function(x) {
      function colorModule(d, i) { return color(i); }
          return {
            id: x.label,
            //To be updated when the scala model is ready finally        
/*            Nvertex: x.vertexTypes.length,
            Nedges: x.edgeTypes.length,*/

            //Handy numbers took from https://github.com/bio4j/bio4j/tree/master/src/main/java/com/bio4j/model  
            Nvertex: x.vertexTypesLength,
            Nedges: x.edgeTypesLength,

            Dependencies: x.dependencies.length,
            Color: colorModule(x)
            };
        });
      
    console.log(newjson0);


/*    var newJsonBundle = newjson0.map(function(x, i) {
      return 
        key: i,
        values: { module: module, label: x.label, propertyTypes: x.properties }  

    })
*/

////////////////////////////////////////////////////////////
  
      //TO DO
/*      var forcelayoutjson = newjson0.map(function(x) {
          return {
            nodes: { module: module, label: x.label, propertyTypes: x.properties },
            links: { module: module, label: x.label, propertyTypes: x.properties }     
            };
        });
      
    console.log(newjson0);*/
    urlForceLayout = "data/rev_schema_new_forceLayout.json";


////////////////////////////////////////////////////////////

    // -------> 1_MODULES AND DEPENDENCIES buttons/loading

    //MODULES AND DEPENDENCIES
    //Filtering between modules and dependencies. For example with circles and rects
    var shapesToFilter = svgModules.select("g").selectAll("circle")
                          .data(newjson0)
                          .enter();

    //svg for MODULES
    shapesToFilter.append("a")
        .attr("xlink:href", "Test-GO_v10_Main.html")
        .append("circle")
        .filter(function(d) { return d.Dependencies < 1;})
        .attr("id", function(d) { return d.id; })
        .attr("cx", function(d, i) { return i*90} )
        .attr("cy", 30 )
        .attr("r", function(d) { return (5 + (+d.Nvertex) ) } )
        .attr("fill", function(d, i) { return color(i); })
        .style("opacity", 0.5);


    //svg for DEPENDENCIES
    shapesToFilter.append("rect")
        .filter(function(d) { return d.Dependencies >= 1;})
        .attr("x", function(d, i) { return 20 + i*100 })
        .attr("y", 30+140 )
        .attr("width", 20 )
        .attr("height", 1.5 );


   //Filtering between modules and dependencies
   textToFilter = svgModules.select("g").selectAll("text")
                            .data(newjson0)
                            .enter();
    //texts for MODULES
    textToFilter.append("text")
        .filter(function(d) { return d.Dependencies < 1;})
        .text(function(d) {
              return d.id;
            })
        .attr("x", function(d,i) { return i*90} )
        .attr("text-anchor", "middle")
        .attr("y", 65 )
        .attr("font-size", "11px");
    
    //texts for DEPENDENCIES
    textToFilter.append("text")
        .filter(function(d) { return d.Dependencies >= 1;})
        .text(function(d) {
              return d.id;
            })
        .attr("x", function(d,i) { return 20 + i*100 +10; } )
        .attr("text-anchor", "middle")
        .attr("y", 55+140 )
        .attr("font-size", "11px");


 //Function for each module url:
    var urlFunction = function(d) {
      return ("data/rev_" + d + ".json")
    };


    //Onclick on each Module, highlight it, define the url path and run the dagre-d3 lib
    svgModules.select("g").selectAll("circle")
        .on("click", function(d) {
            svgModules.select("g").selectAll("circle")
              .style("stroke-width", 0);

            d3.select(this)
              .style("stroke", d3.select(this).attr("fill"))
              .style("stroke-width", 10)
              .style("stroke-opacity", .3);
            console.log(d.id);
            url = urlFunction(d.id);
            console.log(url);
            colorMod = d3.select(this).attr("fill");
            console.log(colorMod);
            return draw();

          });

})
}


/////////////////////////////////////////



 d3.json("data/rev_schema_forceLayout.json", function(error, graph) {
  
  var nodes = graph.nodes


    var Force = function(nodes, links) {
        return d3.layout.force()
            .nodes(nodes)
            .links(links)
            .gravity(0)
            .size([introModulesWidthAux2, introModulesHeightAux2])
            .linkDistance(0)
            // .linkDistance(3)
            // .linkStrength(0.1)
            .linkStrength(.1)
            .friction(0.9)
            .friction(0.9)

            .charge(function(d, i) {
                return d.charge
            })
    };

    var Nodes = function(num, id, name) {
        return d3.range(num).map(function(d) {
            return {
                id: id,
                x: Math.random() * introModulesWidthAux2,
                y: Math.random() * introModulesHeightAux2,
                charge: -2.5,
                name: name,
            }
        })
    };

    console.log("Nodes", Nodes);

    var Foci = function(x, y, name) {
        return {
            x: x,
            y: y,
            charge: 0,
            fixed: true,
            name: name
        }
    };


    var Links = function(nodes, foci) {
        return nodes.map(function(node) {
            return {
                source: node,
                target: foci
            }
        })
    };

//////////////

/*    var groupPath = function(d) {
    return "M" + 
      d3.geom.hull(d.values.map(function(i) { return [i.x, i.y]; }))
        .join("L")
    + "Z";
    };*/

    var hull = svgModulesAux2.append("path")
        .attr("class", "hull");

/////////////



    //TO DEFINE THE COLOR PALETTE:
    var bio4jColors = ["#0E6580", "#68DCFF", "#1BCAFF", "#587680", "#16A2CC", "#68DCFF", "#0E6580 ", "#1BCAFF", "#587680"];

    var color = d3.scale.category10()
        .range(bio4jColors);


    /*        fill = function(d){
              if(d) return 'red'
              else return 'blue'
            }, 
    */


/*    var lengths = function(d) {
        graph.nodes[d].vertexTypesLength
    };*/

    // console.log(graph.nodes[8].vertexTypesLength);

//Convert this in function
var NumNodes0 = graph.nodes[0].vertexTypesLength;
var NumEdges0 = graph.nodes[0].edgeTypesLength;

var NumNodes1 = graph.nodes[1].vertexTypesLength;
var NumEdges1 = graph.nodes[1].edgeTypesLength;

var NumNodes2 = graph.nodes[2].vertexTypesLength;
var NumEdges2 = graph.nodes[2].edgeTypesLength;

var NumNodes3 = graph.nodes[3].vertexTypesLength;
var NumEdges3 = graph.nodes[3].edgeTypesLength;

var NumNodes4 = graph.nodes[4].vertexTypesLength;
var NumEdges4 = graph.nodes[4].edgeTypesLength;

var NumNodes5 = graph.nodes[5].vertexTypesLength;
var NumEdges5 = graph.nodes[5].edgeTypesLength;

var NumNodes6 = graph.nodes[6].vertexTypesLength;
var NumEdges6 = graph.nodes[6].edgeTypesLength;

var NumNodes7 = graph.nodes[7].vertexTypesLength;
var NumEdges7 = graph.nodes[7].edgeTypesLength;

var NumNodes8 = graph.nodes[8].vertexTypesLength;
var NumEdges8 = graph.nodes[8].edgeTypesLength;

/////////////////////

/*var elements0 = (+NumNodes0) + (+NumEdges0);
var elements1 = (+NumNodes1) + (+NumEdges1);
var elements2 = (+NumNodes2) + (+NumEdges2);
var elements3 = (+NumNodes3) + (+NumEdges3);
var elements4 = (+NumNodes4) + (+NumEdges4);
var elements5 = (+NumNodes5) + (+NumEdges5);
var elements6 = (+NumNodes6) + (+NumEdges6);
var elements7 = (+NumNodes7) + (+NumEdges7);
var elements8 = (+NumNodes8) + (+NumEdges8);*/




    var nodes0v = Nodes(NumNodes0, 0, 'node-0'),
        nodes0e = Nodes(NumEdges0, 0, 'edge-0'),
          nodes0 = nodes0v.concat(nodes0e);
        
        nodes1v = Nodes(NumNodes1, 1, 'node-1'),
        nodes1e = Nodes(NumEdges1, 1, 'edge-1'),
          nodes1 = nodes1v.concat(nodes1e);
        
        nodes2v = Nodes(NumNodes2, 2, 'node-2'),
        nodes2e = Nodes(NumEdges2, 2, 'edge-2'),
          nodes2 = nodes2v.concat(nodes2e);

        nodes3v = Nodes(NumNodes3, 3, 'node-3'),
        nodes3e = Nodes(NumEdges3, 3, 'edge-3'),
          nodes3 = nodes3v.concat(nodes3e);
        
        nodes4v = Nodes(NumNodes4, 4, 'node-4'),
        nodes4e = Nodes(NumEdges4, 4, 'edge-4'),
          nodes4 = nodes4v.concat(nodes4e);
       
        nodes5v = Nodes(NumNodes5, 5, 'node-5'),
        nodes5e = Nodes(NumEdges5, 5, 'edge-5'),
          nodes5 = nodes5v.concat(nodes5e);
       
        nodes6v = Nodes(NumNodes6, 6, 'node-6'),
        nodes6e = Nodes(NumEdges6, 6, 'edge-6'),
          nodes6 = nodes6v.concat(nodes6e);
       
        nodes7v = Nodes(NumNodes7, 7, 'node-7'),
        nodes7e = Nodes(NumEdges7, 7, 'edge-7'),
          nodes7 = nodes7v.concat(nodes7e);
          nodes77 = nodes7;
        
        nodes8v = Nodes(NumNodes8, 8, 'node-8');
        nodes8e = Nodes(NumEdges8, 8, 'edge-8');
          nodes8 = nodes8v.concat(nodes8e);

      console.log(nodes0v);
      console.log(nodes0e);
      console.log(nodes0);

    //Number of modules
    var n = 9,
    xModPosition = (introModulesWidthAux2 / (n+1));



    var foci0 = Foci(xModPosition, introModulesHeightAux2 / 2, 'foci-0'),
        foci1 = Foci(introModulesWidthAux2 / (n+1) + 75, introModulesHeightAux2 / 2, 'foci-1'),
        foci2 = Foci(introModulesWidthAux2 / (n+1) + 150, introModulesHeightAux2 / 2, 'foci-2'),
        foci3 = Foci(introModulesWidthAux2 / (n+1) + 225, introModulesHeightAux2 / 2, 'foci-3'),
        foci4 = Foci(introModulesWidthAux2 / (n+1) + 300, introModulesHeightAux2 / 2, 'foci-4'),
        foci5 = Foci(introModulesWidthAux2 / (n+1) + 375, introModulesHeightAux2 / 2, 'foci-5'),
        foci6 = Foci(introModulesWidthAux2 / (n+1) + 450, introModulesHeightAux2 / 2, 'foci-6'),
        foci7 = Foci(introModulesWidthAux2 / (n+1) + 525, introModulesHeightAux2 / 2, 'foci-7'),
        foci8 = Foci(introModulesWidthAux2 / (n+1) + 600, introModulesHeightAux2 / 2 + 50, 'foci-8');

    var links0 = Links(nodes0, foci0),
        links1 = Links(nodes1, foci1),
        links2 = Links(nodes2, foci2),
        links3 = Links(nodes3, foci3),
        links4 = Links(nodes4, foci4),
        links5 = Links(nodes5, foci5),
        links6 = Links(nodes6, foci6),
        links7 = Links(nodes7, foci7),
        links8 = Links(nodes8, foci8);


    var all = nodes0.concat(nodes1).concat(nodes2).concat(nodes3).concat(nodes4).concat(nodes5).concat(nodes6).concat(nodes7).concat(nodes8).concat([             foci0, foci1, foci2, foci3, foci4, foci5, foci6, foci7, foci8]);

    force = Force(all, links0.concat(links1).concat(links2).concat(links3).concat(links4).concat(links5).concat(links6).concat(links7).concat(links8))




    force.on('tick', function() {
        // svgModulesAux2.selectAll('circle')
            types.attr('cx', function(d) {
                return d.x
            })
            .attr('cy', function(d) {
                return d.y
            });
/*
            svgModulesAux2.selectAll("path")
            .data([d3.geom.hull(types.map(function(d) { return [ d.x, d.y ]; }))])
            .attr("d", function(d) { return "M" + d.join("L") + "Z"; });*/


/*        nodes77.attr('x', function(d) {
                return d.x
            })
            .attr('y', function(d) {
                return d.y
            });*/

/*    svgModulesAux2.selectAll("path")
        .data(nodes77)
        .attr("d", groupPath)
        .enter().insert("path")
        .style("fill", "red")
        .style("stroke", "red")
        .style("stroke-width", 20)
        .style("stroke-linejoin", "round")
        .style("opacity", .2)
        .attr("d", groupPath);*/
/*});*/

    


/*    labels.attr("x", function(d) {
            return d.x;
        })
            .attr("y", function(d) {
                return d.y + 3;
            })*/

    })




    ///////////////////

    console.log(all);

    //All vertex and edges: 
    svgtypes = svgModulesAux2
        .append("g")
        .attr("id", "modulesTypes")
        .selectAll('types')
        .data(all)
        .enter()


    types = svgtypes.append('circle')
        // .filter(function(d, i) { return i < 2;})
        .attr({
            cx: function(d) {
                return d.x
            },
            cy: function(d) {
                return d.y
            },
            r: 1.6,
            'class': function(d) {
                return d.name
            }
        })
        .style("fill", function(d) {
            return color(d.id)
        });
        // .call(force.drag);

    //Filtering all edges:
    d3.selectAll(".edge-0, .edge-1, .edge-2, .edge-3, .edge-4, .edge-5, .edge-6, .edge-7, .edge-8")
        .transition(500)
        .attr("r", .7);

    names = [graph.nodes[0].label, graph.nodes[1].label, graph.nodes[2].label, graph.nodes[3].label, graph.nodes[4].label, graph.nodes[5].label, graph.nodes[6].label, graph.nodes[7].label,  graph.nodes[8].label ];
    console.log(names);

      labels = svgModulesAux2
        .append("g")
        .attr("id", "modulesText")
        .selectAll("text")        
        .data(names)
        .enter()
        .append("text")
        .text(function(d) { return d })
        .attr("x", function(d, i) {
            return introModulesWidthAux2 / (n+1) + i*75;
        })
        .attr("y", introModulesHeightAux2 / 2)
        .attr("text-anchor", "middle")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("fill", function(d, i) { return color(i)} );

    /*        .style({
              fill: function(d){ return fill(d.id) }
              , stroke: 'while'
              , 'stroke-width': 1
            })*/

    force.start();
    

/*    prueba3 = d3.select("#modulesTypes")
                .selectAll("circles")
                .each(function(x) {
                  return {
                    x: x.cx,
                    y: x.attr("cy")
                  };
                });*/
    
    // console.log(prueba3);


/*    prueba2 = d3.selectAll("circle").each( function(d,i) {
      return d3.select(this).attr("cx");
      // yPosit = d3.select(this).attr("cy");
    });

      console.log(prueba2);*/

 /* var prueba4Array = [];
    var selection = d3.selectAll(".edge-7").attr("cx");

      for (var i = 0, len = nodes77.length; i < len; i++)
      {
        prueba4Array.push([selection[i]]);
      };

      console.log("prueba4array", prueba4Array);


  var prueba3Array = [];

      for (var i = 0, len = nodes77.length; i < len; i++)
      {
          prueba3Array.push([nodes77[i].x, nodes77[i].y]);
      };
      console.log("prueba3array", prueba3Array);*/

    ////

 /*   console.log("nodes7", nodes7);

    var prueba2Array = [];

      for (var i = 0, len = prueba2.length; i < len; i++)
      {
          prueba2Array.push([prueba2[i]]);
      };

    ////
    
    var nodes7New = nodes7.map(function(x) {
            return {
            x: x.x,
            y: x.y
            };
        });
    
    /////

    var Newnodes7New = [];

      for (var i = 0, len = nodes7New.length; i < len; i++)
      {
          Newnodes7New.push([nodes7New[i]]);
      }
   
   var randomX7 = d3.random.normal(200, 50),
        randomY7 = d3.random.normal(200, 50),
    
    vertices7 = d3.range(50).map(function() { return [randomX7(), randomY7()]; });

    console.log("vertices7 OK", vertices7);
    console.log("nodes7New OBJECT", nodes7New);
    console.log("Newnodes7New MAL", Newnodes7New);*/



/*

redraw();


function redraw() {
  hull.datum(d3.geom.hull(prueba3Array)).attr("d", function(d) { return "M" + d.join("L") + "Z"; })
}


*/

    






/*    var groupPath = function(d) {
        return "M" +
            d3.geom.hull(d.values.map(function(i) {
                return [i.x, i.y];
            }))
            .join("L") + "Z";
    };*/

/*    grupo8 = d3.selectAll(".edge-8 .node-8");
    svgModulesAux2.append("g").append("grupo8");*/

    // CONVEX HULL NOT WORKING YET
/*    var groupPath = function(d) {
        return "M" +
            d3.geom.hull(function(i) {
                return [i.cx, i.cy];
            })
            .join("L") + "Z";
    };

*/

/*
    svgModulesAux2.selectAll("path")
            .data(nodeCircles)
            .attr("d", groupPath)
            .enter().insert("path", "circle")
            .style("fill", "yellow")
            .style("stroke", "green")
            .style("stroke-width", 20)
            .style("stroke-linejoin", "round")
            .style("opacity", .2)
            .attr("d", groupPath);*/


    // d3.select('.foci-1').drag()

    /*      d3.select('.foci-2')
            .transition()
            .ease('cubic-in-out')
            .duration(2000)
            .tween('dataTween', function(d){
              var ix = d3.interpolate(d.x, w / 2)
              var iy = d3.interpolate(d.y, h / 2)
              return function(t){
                d.x = d.px = ix(t)
                d.y = d.py = iy(t)
              }
            })*/
    
    
/*    force.on("tick", function() {

        node.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

       


      })*/
})


</script>






